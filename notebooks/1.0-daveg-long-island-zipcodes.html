<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.468">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Long Island Political Contributions - The Goal</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../notebooks/1.0-daveg-long-island-zipcodes.html">1. Getting Long Island’s Zipcodes</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Long Island Political Contributions</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/1.0-daveg-long-island-zipcodes.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">1. Getting Long Island’s Zipcodes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/2.0-daveg-long-island-contributors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. Finding Long Island Contributors</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/3.0-daveg-long-island-contributions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3. Analyzing Long Island Contributors</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-problem" id="toc-the-problem" class="nav-link active" data-scroll-target="#the-problem">The Problem</a></li>
  <li><a href="#the-gameplan" id="toc-the-gameplan" class="nav-link" data-scroll-target="#the-gameplan">The Gameplan</a></li>
  <li><a href="#geocoding" id="toc-geocoding" class="nav-link" data-scroll-target="#geocoding">Geocoding</a></li>
  <li><a href="#processing-long-island-zip-codes" id="toc-processing-long-island-zip-codes" class="nav-link" data-scroll-target="#processing-long-island-zip-codes">Processing Long Island Zip Codes</a></li>
  <li><a href="#shapefiles-and-geopandas" id="toc-shapefiles-and-geopandas" class="nav-link" data-scroll-target="#shapefiles-and-geopandas">Shapefiles and GeoPandas</a>
  <ul class="collapse">
  <li><a href="#an-interlude---the-sorrows-and-joys-of-open-data" id="toc-an-interlude---the-sorrows-and-joys-of-open-data" class="nav-link" data-scroll-target="#an-interlude---the-sorrows-and-joys-of-open-data">An Interlude - The Sorrows and Joys of Open Data</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">The Goal</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>I want to look at individual contributions to political campaigns just prior to the 2020 presidential election made by people on Long Island. Money is interesting, because there’s a reason that we say “put your money where your mouth is”.</p>
<p>There’s also, as we’ll see, a lot you can learn from the data on its own. It contains things like Occupation and Employer that are just interesting in their own right. We could use it, for instance, to find employers and contacts that we might be interested in. Here’s an example record:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Field</th>
<th style="text-align: left;">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CMTE_ID</td>
<td style="text-align: left;">C00401224</td>
</tr>
<tr class="even">
<td style="text-align: left;">AMNDT_IND</td>
<td style="text-align: left;">N</td>
</tr>
<tr class="odd">
<td style="text-align: left;">RPT_TP</td>
<td style="text-align: left;">MY</td>
</tr>
<tr class="even">
<td style="text-align: left;">TRANSACTION_PGI</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">IMAGE_NUM</td>
<td style="text-align: left;">201907299155126104</td>
</tr>
<tr class="even">
<td style="text-align: left;">TRANSACTION_TP</td>
<td style="text-align: left;">24T</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ENTITY_TP</td>
<td style="text-align: left;">IND</td>
</tr>
<tr class="even">
<td style="text-align: left;">NAME</td>
<td style="text-align: left;">LEVINE, ELIOT</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CITY</td>
<td style="text-align: left;">HUNTINGTON</td>
</tr>
<tr class="even">
<td style="text-align: left;">STATE</td>
<td style="text-align: left;">NY</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ZIP_CODE</td>
<td style="text-align: left;">11743</td>
</tr>
<tr class="even">
<td style="text-align: left;">EMPLOYER</td>
<td style="text-align: left;">SELF</td>
</tr>
<tr class="odd">
<td style="text-align: left;">OCCUPATION</td>
<td style="text-align: left;">LAWYER</td>
</tr>
<tr class="even">
<td style="text-align: left;">TRANSACTION_DT</td>
<td style="text-align: left;">01092019</td>
</tr>
<tr class="odd">
<td style="text-align: left;">TRANSACTION_AMT</td>
<td style="text-align: left;">25</td>
</tr>
<tr class="even">
<td style="text-align: left;">OTHER_ID</td>
<td style="text-align: left;">C00000935</td>
</tr>
<tr class="odd">
<td style="text-align: left;">TRAN_ID</td>
<td style="text-align: left;">SA11AI_144839311</td>
</tr>
<tr class="even">
<td style="text-align: left;">FILE_NUM</td>
<td style="text-align: left;">1344765</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MEMO_CD</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">MEMO_TEXT</td>
<td style="text-align: left;">EARMARKED FOR DCCC (C00000935)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SUB_ID</td>
<td style="text-align: left;">4082820191120772033</td>
</tr>
<tr class="even">
<td style="text-align: left;">postalcode</td>
<td style="text-align: left;">11743</td>
</tr>
</tbody>
</table>
<section id="the-problem" class="level2">
<h2 class="anchored" data-anchor-id="the-problem">The Problem</h2>
<p>The files for 2020 are large - 9GB uncompressed, 18GB compressed. Some large percentage of this data is not really useful for my purpose, and I have to figure out a way to keep only what I need. Filtering on NY is possible, but as I know already and found out even more so as part of this little project, NY is really, really big and very politically active. So, we want to restrict even within NY, to Long Island. But, how should we do that?</p>
<p>We don’t want to use the CITY data because one person’s Bellmore is another person’s North Bellmore (that is, there’s really only one if you don’t live there!). Also, NY is big enough to have two towns with the same name in different counties (Tuckahoe, NY for example!).</p>
<p>Zip codes are more reliable indicators, but then we face a different problem - how do we know which zip codes are on Long Island?</p>
</section>
<section id="the-gameplan" class="level2">
<h2 class="anchored" data-anchor-id="the-gameplan">The Gameplan</h2>
<ul>
<li>Get a list of zip codes that are contained within Long Island (defined as Nassau and Suffolk counties).</li>
<li>Filter the FEC data using our list of zip codes.</li>
<li>Analyze the Long Island FEC data.</li>
</ul>
<p>We start with a list of Zip Codes for the entire US, downloaded from the USPS. We’ll geocode this list of zip codes using the open source Nominatim geocoder, and use polygons for Nassau and Suffolk counties to retrieve only the zip codes we need.</p>
</section>
<section id="geocoding" class="level2">
<h2 class="anchored" data-anchor-id="geocoding">Geocoding</h2>
<p>Geocoding is the process of transforming an address or other geographic information entered by a user into geographical coordinates. We do it so often nowadays that we don’t even think about what a wonderful thing it is! Every time we type an address into Google Maps to get directions, we are using a geocoder.</p>
<p>Geocoding is also a computationally expensive process, and we have a large number of zip codes (just over 2000 in NY state) that we want to geocode. We’ll do this cheaply by using Nominatim, which is the geocoder used by OpenStreetMaps. Building and installing Nominatim locally is an involved process, but we can sidestep it and just use Nominatim in a Docker container. We can follow the instructions here to build and run a Docker instance of Nominatim:</p>
<p>https://www.linkedin.com/pulse/geocoding-geopy-your-own-nominatim-server-chonghua-yin/?trk=related_artice_Geocoding%20with%20GeoPy%20and%20Your%20Own%20Nominatim%20Server_article-card_title</p>
<p>We could interact with this instance directly using http requests, but we’ll use geopy instead. This library allows us to switch geocoders based on the purpose we have in mind, and also allows us to implement rate limiters if the geocoding service requires it. As we’re using our local copy we don’t have to worry about that, but if you were to use OSM’s geocoder directly, be polite!</p>
<div id="cell-3" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geopy.geocoders <span class="im">import</span> Nominatim</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>geocoder <span class="op">=</span> Nominatim(domain<span class="op">=</span><span class="st">"localhost:8080"</span>, scheme<span class="op">=</span><span class="st">"http"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We test it by geocoding the North Bellmore Library!</p>
<div id="cell-5" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>geocoder.geocode(<span class="st">"North Bellmore Library"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>Location(Public Library, 1551, Newbridge Road, North Bellmore, Town of Hempstead, Nassau County, 11710, United States, (40.6831165, -73.53970382629029, 0.0))</code></pre>
</div>
</div>
</section>
<section id="processing-long-island-zip-codes" class="level2">
<h2 class="anchored" data-anchor-id="processing-long-island-zip-codes">Processing Long Island Zip Codes</h2>
<p>We have a list of zip codes provided by the United States Postal Service, for the entire country.</p>
<div id="cell-7" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>zip_codes_df <span class="op">=</span> pd.read_excel(<span class="st">"../references/ZIP_Locale_Detail.xls"</span>, sheet_name<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can filter on PHYSICAL STATE to get only the zip codes in NY.</p>
<div id="cell-9" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ny_zip_codes_df <span class="op">=</span> zip_codes_df[zip_codes_df[<span class="st">"PHYSICAL STATE"</span>]<span class="op">==</span><span class="st">"NY"</span>].copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Amusingly, there is one zip code that is physically in NY but serviced as part of Connecticut. This is Fisher’s Island, which is in the Sound but whose ferry service is from Connecticut. The more you know!</p>
<div id="cell-11" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ny_zip_codes_df[<span class="st">"DISTRICT NAME"</span>].value_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>DISTRICT NAME
NEW YORK 3     1756
NEW YORK 2      309
NEW YORK 1      208
CONNECTICUT       1
Name: count, dtype: int64</code></pre>
</div>
</div>
</section>
<section id="shapefiles-and-geopandas" class="level2">
<h2 class="anchored" data-anchor-id="shapefiles-and-geopandas">Shapefiles and GeoPandas</h2>
<p>We are interested primarily in Nassau and Suffolk counties. Happily, NYS has the boundaries of those counties available to us in Shapefile format. Shapefiles are a data format originally created by ESRI, makers of ArcGIS software. It caught on as a popular format for exchanging spatial data. Many other formats are available now - GeoJSON is particularly popular now - but Shapefiles are everywhere, particularly for government data. New York State maintains a GIS clearinghouse with all kinds of useful assets, including polygon representations of all its counties. We use this file to select the spatial definitions for Nassau and Suffolk counties.</p>
<p>We also use the GeoPandas library, which lets us turn the shapefiles into Pandas dataframes with a special Geometry column that we can use in spatial operations.</p>
<div id="cell-13" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>counties_gdf <span class="op">=</span> gpd.read_file(<span class="st">"../references/shapefiles/Counties.shp"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Also happily, the names are spelled the way we expect. We use GeoPandas to project the county polygons into WGS84, a system that uses latitude and longitude. We need to use the same coordinate system for the counties and the zipcodes we will work with below.</p>
<div id="cell-15" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>long_island_gdf <span class="op">=</span> counties_gdf[counties_gdf.NAME.isin([<span class="st">"Nassau"</span>,<span class="st">"Suffolk"</span>])].copy()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>long_island_gdf <span class="op">=</span> long_island_gdf.to_crs(<span class="dv">4326</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>long_island_gdf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">NAME</th>
<th data-quarto-table-cell-role="th">ABBREV</th>
<th data-quarto-table-cell-role="th">GNIS_ID</th>
<th data-quarto-table-cell-role="th">FIPS_CODE</th>
<th data-quarto-table-cell-role="th">SWIS</th>
<th data-quarto-table-cell-role="th">NYSP_ZONE</th>
<th data-quarto-table-cell-role="th">POP1990</th>
<th data-quarto-table-cell-role="th">POP2000</th>
<th data-quarto-table-cell-role="th">POP2010</th>
<th data-quarto-table-cell-role="th">POP2020</th>
<th data-quarto-table-cell-role="th">DOS_LL</th>
<th data-quarto-table-cell-role="th">DOSLL_DATE</th>
<th data-quarto-table-cell-role="th">NYC</th>
<th data-quarto-table-cell-role="th">CALC_SQ_MI</th>
<th data-quarto-table-cell-role="th">DATEMOD</th>
<th data-quarto-table-cell-role="th">Shape_Leng</th>
<th data-quarto-table-cell-role="th">Shape_Area</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">29</td>
<td>Nassau</td>
<td>NASS</td>
<td>974128</td>
<td>36059</td>
<td>280000</td>
<td>Long Island</td>
<td>1287348</td>
<td>1334544</td>
<td>1339532</td>
<td>1395774</td>
<td>NaN</td>
<td>NaN</td>
<td>N</td>
<td>446.637468</td>
<td>2018-04-12</td>
<td>168031.844843</td>
<td>1.156786e+09</td>
<td>POLYGON ((-73.42898 40.97791, -73.42934 40.940...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">51</td>
<td>Suffolk</td>
<td>SUFF</td>
<td>974149</td>
<td>36103</td>
<td>470000</td>
<td>Long Island</td>
<td>1321864</td>
<td>1419369</td>
<td>1493350</td>
<td>1525920</td>
<td>NaN</td>
<td>NaN</td>
<td>N</td>
<td>2372.634185</td>
<td>NaN</td>
<td>385044.837960</td>
<td>6.145094e+09</td>
<td>POLYGON ((-72.13717 40.90804, -72.15988 40.899...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As mentioned above, geocoding is expensive and we don’t want to do it unnecessarily. There is duplication in the file we received from the USPS. For instance, there are two post offices in Bellmore, one north and one south, but Bellmore only has one zip code (11710). There’s no point to calling the same operation twice.</p>
<div id="cell-17" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ny_zip_codes_df[ny_zip_codes_df[<span class="st">"PHYSICAL ZIP"</span>]<span class="op">==</span><span class="dv">11710</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">AREA NAME</th>
<th data-quarto-table-cell-role="th">AREA CODE</th>
<th data-quarto-table-cell-role="th">DISTRICT NAME</th>
<th data-quarto-table-cell-role="th">DISTRICT NO</th>
<th data-quarto-table-cell-role="th">DELIVERY ZIPCODE</th>
<th data-quarto-table-cell-role="th">LOCALE NAME</th>
<th data-quarto-table-cell-role="th">PHYSICAL DELV ADDR</th>
<th data-quarto-table-cell-role="th">PHYSICAL CITY</th>
<th data-quarto-table-cell-role="th">PHYSICAL STATE</th>
<th data-quarto-table-cell-role="th">PHYSICAL ZIP</th>
<th data-quarto-table-cell-role="th">PHYSICAL ZIP 4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">4290</td>
<td>ATLANTIC</td>
<td>4B</td>
<td>NEW YORK 2</td>
<td>117</td>
<td>11710</td>
<td>BELLMORE</td>
<td>2611 MERRICK RD</td>
<td>BELLMORE</td>
<td>NY</td>
<td>11710</td>
<td>5752.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4291</td>
<td>ATLANTIC</td>
<td>4B</td>
<td>NEW YORK 2</td>
<td>117</td>
<td>11710</td>
<td>NORTH BELLMORE</td>
<td>2465 JERUSALEM AVE</td>
<td>NORTH BELLMORE</td>
<td>NY</td>
<td>11710</td>
<td>9991.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Just for fun, I tested it with my own town. The location given appears to be the geometric center of Bellmore, rather than the address of one of its two post offices. That’s certainly going to fall within Nassau county.</p>
<div id="cell-19" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> geocoder.geocode(<span class="st">"11710"</span>, featuretype<span class="op">=</span><span class="st">"postalcode"</span>, addressdetails<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>Location(Bellmore, Town of Hempstead, Nassau County, 11710, United States, (40.67664607465925, -73.53396529349835, 0.0))</code></pre>
</div>
</div>
<p>We come up with a smaller list by restricting the columns and dropping duplicates. We also make all zipcodes the same length and replace spaces with 0, which we have to do because of Fisher Island. We then run the geocoder on the resulting postcodes.</p>
<div id="cell-21" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ny_zip_only_df <span class="op">=</span> ny_zip_codes_df[[<span class="st">"PHYSICAL CITY"</span>, <span class="st">"LOCALE NAME"</span>, <span class="st">"DELIVERY ZIPCODE"</span>, <span class="st">"PHYSICAL ZIP"</span>]].drop_duplicates()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ny_zip_only_df[<span class="st">"postalcode"</span>] <span class="op">=</span> ny_zip_only_df[<span class="st">"PHYSICAL ZIP"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="bu">str</span>(<span class="bu">int</span>(x)).rjust(<span class="dv">5</span>, <span class="st">"0"</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>ny_zip_only_df[<span class="st">"geocode"</span>] <span class="op">=</span> ny_zip_only_df[<span class="st">"postalcode"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: geocoder.geocode(query<span class="op">=</span>{<span class="st">"postalcode"</span>: x}))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="an-interlude---the-sorrows-and-joys-of-open-data" class="level3">
<h3 class="anchored" data-anchor-id="an-interlude---the-sorrows-and-joys-of-open-data">An Interlude - The Sorrows and Joys of Open Data</h3>
<p>The surprising thing (perhaps) is that we are missing a fair amount of data. Take one example, for Niobe NY. There wasn’t a zipcode associated with the data in Open Street Map (I’ve added one!). Open Street Map relies on public “donations” of data, and it seems that the good people of Niobe may not be aware of the need. We are fortunate that Long Island is very well supported in Open Street Map. If we were looking at a less fortunate area, we might have to invest in a commercial geocoder.</p>
<div id="cell-23" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>ny_zip_only_df[ny_zip_only_df.geocode.isnull()]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">PHYSICAL CITY</th>
<th data-quarto-table-cell-role="th">LOCALE NAME</th>
<th data-quarto-table-cell-role="th">DELIVERY ZIPCODE</th>
<th data-quarto-table-cell-role="th">PHYSICAL ZIP</th>
<th data-quarto-table-cell-role="th">postalcode</th>
<th data-quarto-table-cell-role="th">geocode</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">3936</td>
<td>MAHOPAC FALLS</td>
<td>MAHOPAC FALLS</td>
<td>10542</td>
<td>10542</td>
<td>10542</td>
<td>None</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3938</td>
<td>MARYKNOLL</td>
<td>MARYKNOLL</td>
<td>10545</td>
<td>10545</td>
<td>10545</td>
<td>None</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3965</td>
<td>SHENOROCK</td>
<td>SHENOROCK</td>
<td>10587</td>
<td>10587</td>
<td>10587</td>
<td>None</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4039</td>
<td>NEW MILFORD</td>
<td>NEW MILFORD</td>
<td>10959</td>
<td>10959</td>
<td>10959</td>
<td>None</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4202</td>
<td>BROOKLYN</td>
<td>OZONE PARK CARRIER ANNEX</td>
<td>11416</td>
<td>11256</td>
<td>11256</td>
<td>None</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5888</td>
<td>NIOBE</td>
<td>NIOBE</td>
<td>14758</td>
<td>14758</td>
<td>14758</td>
<td>None</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5899</td>
<td>SAINT BONAVENTURE</td>
<td>SAINT BONAVENTURE</td>
<td>14778</td>
<td>14778</td>
<td>14778</td>
<td>None</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5906</td>
<td>WEST CLARKSVILLE</td>
<td>WEST CLARKSVILLE</td>
<td>14786</td>
<td>14786</td>
<td>14786</td>
<td>None</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5939</td>
<td>COOPERS PLAINS</td>
<td>COOPERS PLAINS</td>
<td>14827</td>
<td>14827</td>
<td>14827</td>
<td>None</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5960</td>
<td>KANONA</td>
<td>KANONA</td>
<td>14856</td>
<td>14856</td>
<td>14856</td>
<td>None</td>
</tr>
</tbody>
</table>

<p>77 rows × 6 columns</p>
</div>
</div>
</div>
<p>For now, we drop any records that were not geocoded successfully and apply a function to the rest to get a 2-dimensional point.</p>
<div id="cell-25" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>ny_zip_geocoded_df <span class="op">=</span> ny_zip_only_df.dropna().copy()</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>ny_zip_geocoded_df[<span class="st">"Point"</span>] <span class="op">=</span> ny_zip_geocoded_df[<span class="st">"geocode"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: Point(x.longitude, x.latitude))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We build a GeoPandas dataframe from the data.</p>
<div id="cell-27" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ny_zip_geocoded_gdf <span class="op">=</span> gpd.GeoDataFrame(ny_zip_geocoded_df, geometry<span class="op">=</span>ny_zip_geocoded_df[<span class="st">"Point"</span>], crs<span class="op">=</span><span class="dv">4326</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With our data in a dataframe, we can plot these zip code positions using Kepler. The picture looks an awful lot like NY!</p>
<div id="cell-29" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keplergl <span class="im">import</span> KeplerGl</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>ny_map <span class="op">=</span> KeplerGl(height<span class="op">=</span><span class="dv">800</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>ny_map.add_data(ny_zip_geocoded_gdf[[<span class="st">"LOCALE NAME"</span>, <span class="st">"geometry"</span>]])</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>ny_map.save_to_html()</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>ny_map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>User Guide: https://docs.kepler.gl/docs/keplergl-jupyter
Map saved to keplergl_map.html!</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3d4108ed7d7a4b198c3408788dcc6d03","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<pre class="{html}"><code>&lt;iframe width="800" height="500" src="keplegl_map.html" title="NY Zipcodes"&gt;&lt;/iframe&gt;</code></pre>
<p>We can now do a spatial join between the polygons representing Nassau and Suffolk counties, and the points (longitude and latitude) returned by our geocoder. This operation is written in GeoPandas and is fairly efficient, at least for this relatively small amount of data.</p>
<div id="cell-32" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>long_island_zipcodes_df <span class="op">=</span> gpd.sjoin(ny_zip_geocoded_gdf, long_island_gdf, predicate<span class="op">=</span><span class="st">"within"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Bellmore only has one entry in the list, as we might expect. It is within Nassau County, which is a relief.</p>
<div id="cell-34" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>long_island_zipcodes_df[long_island_zipcodes_df[<span class="st">"PHYSICAL CITY"</span>]<span class="op">==</span><span class="st">'BELLMORE'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">PHYSICAL CITY</th>
<th data-quarto-table-cell-role="th">LOCALE NAME</th>
<th data-quarto-table-cell-role="th">DELIVERY ZIPCODE</th>
<th data-quarto-table-cell-role="th">PHYSICAL ZIP</th>
<th data-quarto-table-cell-role="th">postalcode</th>
<th data-quarto-table-cell-role="th">geocode</th>
<th data-quarto-table-cell-role="th">Point</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">index_right</th>
<th data-quarto-table-cell-role="th">NAME</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">POP2000</th>
<th data-quarto-table-cell-role="th">POP2010</th>
<th data-quarto-table-cell-role="th">POP2020</th>
<th data-quarto-table-cell-role="th">DOS_LL</th>
<th data-quarto-table-cell-role="th">DOSLL_DATE</th>
<th data-quarto-table-cell-role="th">NYC</th>
<th data-quarto-table-cell-role="th">CALC_SQ_MI</th>
<th data-quarto-table-cell-role="th">DATEMOD</th>
<th data-quarto-table-cell-role="th">Shape_Leng</th>
<th data-quarto-table-cell-role="th">Shape_Area</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">4290</td>
<td>BELLMORE</td>
<td>BELLMORE</td>
<td>11710</td>
<td>11710</td>
<td>11710</td>
<td>(Bellmore, Town of Hempstead, Nassau County, 1...</td>
<td>POINT (-73.53396529349835 40.67664607465925)</td>
<td>POINT (-73.53397 40.67665)</td>
<td>29</td>
<td>Nassau</td>
<td>...</td>
<td>1334544</td>
<td>1339532</td>
<td>1395774</td>
<td>NaN</td>
<td>NaN</td>
<td>N</td>
<td>446.637468</td>
<td>2018-04-12</td>
<td>168031.844843</td>
<td>1.156786e+09</td>
</tr>
</tbody>
</table>

<p>1 rows × 26 columns</p>
</div>
</div>
</div>
<p>We save our list of zipcodes to a file for use in filtering the Federal Election data in our next notebook!</p>
<div id="cell-36" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>long_island_zipcodes_df[<span class="st">"address"</span>] <span class="op">=</span> long_island_zipcodes_df[<span class="st">"geocode"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.address)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>long_island_zipcodes_df[<span class="st">"locality"</span>] <span class="op">=</span> long_island_zipcodes_df[<span class="st">"address"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.split(<span class="st">","</span>)[<span class="dv">0</span>])</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>long_island_zipcodes_df <span class="op">=</span> long_island_zipcodes_df.rename(columns<span class="op">=</span>{<span class="st">"NAME"</span>: <span class="st">"County"</span>})</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>long_island_zipcodes_df <span class="op">=</span> long_island_zipcodes_df[[<span class="st">"County"</span>, <span class="st">"address"</span>, <span class="st">"locality"</span>, <span class="st">"postalcode"</span>, <span class="st">"PHYSICAL ZIP"</span>, <span class="st">"Point"</span>]].drop_duplicates()</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>long_island_zipcodes_gdf <span class="op">=</span> gpd.GeoDataFrame(long_island_zipcodes_df.drop(<span class="st">"Point"</span>, axis<span class="op">=</span><span class="st">"columns"</span>), geometry<span class="op">=</span>long_island_zipcodes_df[<span class="st">"Point"</span>])</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>long_island_zipcodes_gdf.to_file(<span class="st">"../references/long_island_zipcodes.geojson"</span>, driver<span class="op">=</span><span class="st">"GeoJSON"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can confirm that the zip codes are on Long Island using Kepler.</p>
<div id="cell-38" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keplergl <span class="im">import</span> KeplerGl</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>li_zip_map <span class="op">=</span> KeplerGl(height<span class="op">=</span><span class="dv">800</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>li_zip_map.add_data(long_island_zipcodes_gdf)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>li_zip_map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>User Guide: https://docs.kepler.gl/docs/keplergl-jupyter</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d83d26abd2d74f7e95edb8f10defaddb","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>